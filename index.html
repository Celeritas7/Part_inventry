<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºåº«ä¾é ¼å…¥åŠ›</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Google API for Sheets -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <!-- Header with icons -->
            <div class="app-header">
                <div class="app-title">
                    <h1>ğŸ“¦ å‡ºåº«ä¾é ¼å…¥åŠ›</h1>
                    <p class="subtitle">ç”Ÿç”£ãƒãƒ¼ãƒ å‡ºåº«ä¾é ¼ã‚·ãƒ¼ãƒˆ</p>
                </div>
                <div class="header-icons" id="header-icons" style="display: none;">
                    <button class="header-icon-btn" onclick="openFinderModal()" title="éƒ¨å“æ¤œç´¢">ğŸ”</button>
                    <button class="header-icon-btn admin-only" id="sheet-selector-btn" onclick="openSheetSelectorModal()" title="ã‚·ãƒ¼ãƒˆé¸æŠ" style="display: none;">ğŸ“Š</button>
                    <button class="header-icon-btn" onclick="openSettingsModal()" title="è¨­å®š">âš™ï¸</button>
                </div>
            </div>

            <!-- Loading Section -->
            <div id="loading-section">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>

            <!-- Login Section -->
            <div id="login-section" style="display: none;">
                <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button class="login-btn" onclick="handleGoogleLogin()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
                <p id="login-error"></p>
            </div>

            <!-- Main App Section -->
            <div id="app-section" style="display: none;">
                <div class="user-info">
                    <span id="user-display"></span>
                    <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <!-- Main Content (Batch Entry - default view) -->
                <div id="batch-content">
                    <div class="current-sheet" id="current-sheet">
                        ğŸ“… å¯¾è±¡ã‚·ãƒ¼ãƒˆ: èª­ã¿è¾¼ã¿ä¸­...
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="action-btn" id="scan-add-btn" onclick="toggleScanner()">
                            ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³è¿½åŠ 
                        </button>
                        <button class="action-btn" onclick="openPasteModal()">
                            ğŸ“‹ ãƒªã‚¹ãƒˆè²¼ä»˜ã‘
                        </button>
                    </div>

                    <!-- QR Scanner -->
                    <div id="qr-reader" class="qr-reader-container"></div>

                    <!-- Parts List -->
                    <div class="parts-list" id="parts-list">
                        <div class="parts-list-empty">
                            QRã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯ãƒªã‚¹ãƒˆè²¼ä»˜ã‘ã§éƒ¨å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="remarks-section">
                        <label>å‚™è€ƒæ¬„ (å…±é€š)</label>
                        <textarea id="remarks" placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button class="submit-btn" id="submit-btn" onclick="submitBatch()" disabled>
                        ä¸€æ‹¬ç™»éŒ²ã™ã‚‹ (0ä»¶)
                    </button>

                    <div class="status" id="batch-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div class="modal-overlay" id="paste-modal">
        <div class="modal">
            <h2>ğŸ“‹ éƒ¨å“ç•ªå·ãƒªã‚¹ãƒˆè²¼ä»˜ã‘</h2>
            <p style="color: #666; margin-bottom: 12px; font-size: 0.9rem;">
                éƒ¨å“ç•ªå·ã‚’æ”¹è¡Œã§åŒºåˆ‡ã£ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
            </p>
            <textarea id="paste-textarea" placeholder="GPMP-0540010-0-2
GPCP-0000360-0-0
GPCP-0000154-0-0"></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closePasteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn confirm" onclick="processPastedList()">è¿½åŠ ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Part Finder Modal -->
    <div class="modal-overlay" id="finder-modal">
        <div class="modal finder-modal">
            <div class="modal-header">
                <h2>ğŸ” éƒ¨å“æ¤œç´¢</h2>
                <button class="modal-close-btn" onclick="closeFinderModal()">âœ•</button>
            </div>
            <p class="finder-hint">éƒ¨å“ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°ã®å ´åˆã¯æ”¹è¡Œã§åŒºåˆ‡ã‚‹ï¼‰</p>
            <textarea class="finder-input" id="finder-input" placeholder="GPMP-0540010-0-2
GPCP-0000360-0-0
GPCP-0000154-0-0"></textarea>
            <button class="submit-btn finder-btn" onclick="findParts()">
                ğŸ” éƒ¨å“ã‚’æ¤œç´¢
            </button>
            <div class="status" id="finder-status"></div>
            <div class="finder-results" id="finder-results"></div>
        </div>
    </div>

    <!-- Sheet Selector Modal (Admin Only) -->
    <div class="modal-overlay" id="sheet-selector-modal">
        <div class="modal sheet-selector-modal">
            <div class="modal-header">
                <h2>ğŸ“Š ã‚·ãƒ¼ãƒˆé¸æŠ</h2>
                <button class="modal-close-btn" onclick="closeSheetSelectorModal()">âœ•</button>
            </div>
            <p style="color: #666; margin-bottom: 16px; font-size: 0.9rem;">
                ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„
            </p>
            <div class="sheet-options">
                <label class="sheet-option">
                    <input type="radio" name="sheet" value="production" checked onchange="onSheetChange()">
                    <span class="sheet-option-content">
                        <span class="sheet-option-icon">ğŸ“‹</span>
                        <span class="sheet-option-text">
                            <strong>ç”Ÿç”£ãƒãƒ¼ãƒ å‡ºåº«ä¾é ¼ã‚·ãƒ¼ãƒˆ</strong>
                            <small>æœ¬ç•ªç”¨ã‚·ãƒ¼ãƒˆ</small>
                        </span>
                    </span>
                </label>
                <label class="sheet-option">
                    <input type="radio" name="sheet" value="test" onchange="onSheetChange()">
                    <span class="sheet-option-content">
                        <span class="sheet-option-icon">ğŸ§ª</span>
                        <span class="sheet-option-text">
                            <strong>ãƒ†ã‚¹ãƒˆç”¨ã‚·ãƒ¼ãƒˆ</strong>
                            <small>å‹•ä½œç¢ºèªç”¨</small>
                        </span>
                    </span>
                </label>
            </div>
            <button class="modal-btn confirm" onclick="closeSheetSelectorModal()" style="width: 100%; margin-top: 16px;">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal settings-modal">
            <div class="modal-header">
                <h2>âš™ï¸ è¨­å®š</h2>
                <button class="modal-close-btn" onclick="closeSettingsModal()">âœ•</button>
            </div>
            
            <div class="settings-section">
                <h3>ğŸ¨ ãƒ†ãƒ¼ãƒ</h3>
                <div class="theme-options">
                    <button class="theme-btn" data-theme="purple" onclick="setTheme('purple')">
                        <span class="theme-preview purple"></span>
                        <span>ãƒ‘ãƒ¼ãƒ—ãƒ«</span>
                    </button>
                    <button class="theme-btn" data-theme="blue" onclick="setTheme('blue')">
                        <span class="theme-preview blue"></span>
                        <span>ãƒ–ãƒ«ãƒ¼</span>
                    </button>
                    <button class="theme-btn" data-theme="green" onclick="setTheme('green')">
                        <span class="theme-preview green"></span>
                        <span>ã‚°ãƒªãƒ¼ãƒ³</span>
                    </button>
                    <button class="theme-btn" data-theme="orange" onclick="setTheme('orange')">
                        <span class="theme-preview orange"></span>
                        <span>ã‚ªãƒ¬ãƒ³ã‚¸</span>
                    </button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">
                        <span class="theme-preview dark"></span>
                        <span>ãƒ€ãƒ¼ã‚¯</span>
                    </button>
                </div>
            </div>
            
            <button class="modal-btn confirm" onclick="closeSettingsModal()" style="width: 100%; margin-top: 20px;">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <!-- Unit Code Modal -->
    <div class="unit-modal-overlay" id="unit-modal">
        <div class="unit-modal">
            <div class="unit-modal-header">
                <h3>ğŸ­ Unit S/N æ¤œç´¢</h3>
                <button class="unit-modal-close" onclick="closeUnitModal()">âœ•</button>
            </div>
            
            <p style="color: #666; font-size: 0.85rem; margin-bottom: 12px;">
                Ghost Trackerã‹ã‚‰å®Œå…¨ãªS/Nã‚’æ¤œç´¢ã—ã¾ã™
            </p>
            
            <div class="unit-modal-chips">
                <button class="unit-modal-chip" data-code="Ghost" onclick="selectUnitChip('Ghost')">ğŸ‘» Ghost</button>
                <button class="unit-modal-chip" data-code="MB" onclick="selectUnitChip('MB')">ğŸ› MB</button>
                <button class="unit-modal-chip" data-code="Pillar" onclick="selectUnitChip('Pillar')">ğŸ›ï¸ Pillar</button>
                <button class="unit-modal-chip" data-code="H&B" onclick="selectUnitChip('H&B')">ğŸ§  H&B</button>
                <button class="unit-modal-chip" data-code="Arm" onclick="selectUnitChip('Arm')">ğŸ¦¾ Arm</button>
                <button class="unit-modal-chip" data-code="Gripper" onclick="selectUnitChip('Gripper')">ğŸ¤ Gripper</button>
                <button class="unit-modal-chip" data-code="DK" onclick="selectUnitChip('DK')">ğŸ“¦ DK</button>
                <button class="unit-modal-chip" data-code="L-Mot" onclick="selectUnitChip('L-Mot')">âš™ï¸ L-Mot</button>
                <button class="unit-modal-chip" data-code="A12" onclick="selectUnitChip('A12')">âš™ï¸ A12</button>
                <button class="unit-modal-chip" data-code="A35" onclick="selectUnitChip('A35')">âš™ï¸ A35</button>
                <button class="unit-modal-chip" data-code="A4" onclick="selectUnitChip('A4')">âš™ï¸ A4</button>
            </div>
            
            <div class="unit-modal-number">
                <label>ç•ªå·ã‚’å…¥åŠ› (ä¾‹: 34, 105, 426)</label>
                <input type="number" id="unit-number-input" placeholder="34" oninput="onUnitNumberChange(this.value)">
            </div>
            
            <button class="unit-confirm-btn" id="unit-confirm-btn" onclick="confirmUnitSelection()" disabled>
                Unitã‚’é¸æŠã—ã¦ãã ã•ã„
            </button>
        </div>
    </div>

    <script>
        // =====================================================
        // FIREBASE CONFIGURATION
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAn-N_OPbPGG5pzkQUc4vgP8C-QLf6jgls",
            authDomain: "part-inventry-app.firebaseapp.com",
            projectId: "part-inventry-app",
            storageBucket: "part-inventry-app.firebasestorage.app",
            messagingSenderId: "503579604735",
            appId: "1:503579604735:web:cc9915b63a8178145bbeca",
            measurementId: "G-XL1VNHPFTY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // =====================================================
        // GOOGLE SHEETS CONFIGURATION
        // =====================================================
        const SHEETS_CONFIG = {
            SPREADSHEETS: {
                production: {
                    id: '1pGy5OkQd8i4tVlYbcG7afkeDHEdjaZIwwuq6Wqv96jM',
                    name: 'ç”Ÿç”£ãƒãƒ¼ãƒ å‡ºåº«ä¾é ¼ã‚·ãƒ¼ãƒˆ',
                    database: 'Database_new'
                },
                test: {
                    id: '1hTbs5vFzaEAQ87y078-_O5xoP_ad3joRGkneC-8yNzk',
                    name: 'ãƒ†ã‚¹ãƒˆç”¨ã‚·ãƒ¼ãƒˆ',
                    database: 'Database_new'
                }
            }
        };

        // Purpose options
        const PURPOSE_OPTIONS = [
            'é€šå¸¸çµ„ç«‹', 'ä¸è‰¯éƒ¨å“', 'ä»•æç™ºç”Ÿ', 'PICK UPä¸è¶³', 'å¸‚å ´å“ä¿®ç†',
            'ECNå¯¾å¿œ', 'BYæ§‹ç¯‰', 'ç”Ÿç”£ã‚¸ã‚°', 'ç¢ºèªä¸­', 'ãã®ä»–', 'å‡ºåº«ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        ];

        // Unit codes for S/N input with Ghost Tracker sheet mapping
        const UNIT_CODES = [
            { code: 'Ghost', icon: 'ğŸ‘»', sheetTab: '00_GHOST', snCode: 'GST' },
            { code: 'MB', icon: 'ğŸ›', sheetTab: '05_Mobile Base', snCode: 'MBB' },
            { code: 'Pillar', icon: 'ğŸ›ï¸', sheetTab: '06_Pillar', snCode: 'PLR' },
            { code: 'H&B', icon: 'ğŸ§ ', sheetTab: '07_Head & Body', snCode: 'HBD' },
            { code: 'Arm', icon: 'ğŸ¦¾', sheetTab: '09_Arm', snCode: 'ARM' },
            { code: 'Gripper', icon: 'ğŸ¤', sheetTab: '08_Gripper', snCode: 'GPR' },
            { code: 'DK', icon: 'ğŸ“¦', sheetTab: '10_Deploy Kit', snCode: 'DPK' },
            { code: 'L-Mot', icon: 'âš™ï¸', sheetTab: '01_L-motor', snCode: 'LAC' },
            { code: 'A12', icon: 'âš™ï¸', sheetTab: '02_A12-motor', snCode: 'A12' },
            { code: 'A35', icon: 'âš™ï¸', sheetTab: '03_A35-motor', snCode: 'A35' },
            { code: 'A4', icon: 'âš™ï¸', sheetTab: '04_A4-motor', snCode: 'A4A' }
        ];

        // Ghost Tracker Sheet ID
        const GHOST_TRACKER_SHEET_ID = '1mUhNDzucbHpS2y-IYu3A5ML1x5I_opUeNnqqyOtg95M';

        // =====================================================
        // STATE
        // =====================================================
        let currentUser = null;
        let userProfile = null;
        let accessToken = null;
        let html5QrCode = null;
        let scannerActive = false;
        let snScanner = null;
        let snScannerActive = false;
        let snScannerIndex = -1;
        let parts = [];
        let databaseCache = null;
        let currentSheet = 'production';

        // =====================================================
        // INITIALIZATION
        // =====================================================
        window.onload = function() {
            showLoading();
            
            // Listen for auth state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await checkUserApproval(user);
                } else {
                    currentUser = null;
                    userProfile = null;
                    showLogin();
                }
            });
        };

        function showLoading() {
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('app-section').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loading-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'block';
            document.getElementById('header-icons').style.display = 'flex';

            // Update user display
            let userDisplay = `ğŸ‘¤ ${userProfile.name}`;
            if (userProfile.isAdmin) {
                userDisplay += '<span class="user-badge admin">ç®¡ç†è€…</span>';
            }
            userDisplay += `<span class="user-badge team">${userProfile.team}</span>`;
            document.getElementById('user-display').innerHTML = userDisplay;

            // Show sheet selector button for admin only
            if (userProfile.isAdmin) {
                document.getElementById('sheet-selector-btn').style.display = 'flex';
            } else {
                document.getElementById('sheet-selector-btn').style.display = 'none';
            }

            updateCurrentSheetDisplay();
            initGoogleSheetsAPI();
            loadSavedTheme();
        }

        // =====================================================
        // AUTHENTICATION
        // =====================================================
        async function handleGoogleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/spreadsheets');
            
            try {
                const result = await auth.signInWithPopup(provider);
                // Get the Google Access Token for Sheets API
                accessToken = result.credential.accessToken;
                localStorage.setItem('sheets_access_token', accessToken);
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function checkUserApproval(user) {
            try {
                const doc = await db.collection('approved_users').doc(user.email).get();
                
                if (doc.exists) {
                    userProfile = doc.data();
                    userProfile.email = user.email;
                    
                    // Try to get stored access token
                    if (!accessToken) {
                        accessToken = localStorage.getItem('sheets_access_token');
                    }
                    
                    showApp();
                } else {
                    // User not approved
                    await auth.signOut();
                    showLoginError(`ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚\n${user.email} ã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚`);
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking user approval:', error);
                showLoginError('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                showLogin();
            }
        }

        function handleLogout() {
            auth.signOut();
            localStorage.removeItem('sheets_access_token');
            accessToken = null;
            userProfile = null;
            parts = [];
            databaseCache = null;
            currentSheet = 'production';
            stopScanner();
            closeSnScanner();
        }

        function showLoginError(message) {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideLoginError() {
            document.getElementById('login-error').style.display = 'none';
        }

        // =====================================================
        // GOOGLE SHEETS API
        // =====================================================
        function initGoogleSheetsAPI() {
            // If we don't have a token, user needs to re-login
            if (!accessToken) {
                console.log('No access token, user may need to re-login for Sheets access');
            }
        }

        async function sheetsApiRequest(url, options = {}, isRetry = false) {
            if (!accessToken) {
                // Try to get a new token
                await refreshAccessToken();
                if (!accessToken) {
                    throw new Error('Google Sheetsèªè¨¼ãŒå¿…è¦ã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                }
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                // Token expired - try to refresh automatically
                if (!isRetry) {
                    console.log('Token expired, refreshing...');
                    await refreshAccessToken();
                    if (accessToken) {
                        // Retry the request with new token
                        return sheetsApiRequest(url, options, true);
                    }
                }
                // Refresh failed
                localStorage.removeItem('sheets_access_token');
                accessToken = null;
                throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API error');
            }

            return response.json();
        }

        // Auto refresh access token
        async function refreshAccessToken() {
            return new Promise((resolve) => {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/spreadsheets');
                
                // Use reauthenticateWithPopup to get new token
                const user = auth.currentUser;
                if (user) {
                    user.getIdToken(true).then(() => {
                        // Re-authenticate to get new access token
                        auth.currentUser.reauthenticateWithPopup(provider).then((result) => {
                            accessToken = result.credential.accessToken;
                            localStorage.setItem('sheets_access_token', accessToken);
                            console.log('Token refreshed successfully');
                            resolve(true);
                        }).catch((error) => {
                            console.error('Token refresh failed:', error);
                            resolve(false);
                        });
                    });
                } else {
                    resolve(false);
                }
            });
        }

        // =====================================================
        // SHEET SELECTION
        // =====================================================
        function onSheetChange() {
            const selectedSheet = document.querySelector('input[name="sheet"]:checked');
            if (selectedSheet) {
                currentSheet = selectedSheet.value;
                databaseCache = null;
                updateCurrentSheetDisplay();
            }
        }

        function getCurrentSpreadsheetId() {
            return SHEETS_CONFIG.SPREADSHEETS[currentSheet].id;
        }

        function getCurrentDatabaseSheet() {
            return SHEETS_CONFIG.SPREADSHEETS[currentSheet].database;
        }

        // =====================================================
        // MODAL FUNCTIONS
        // =====================================================
        function openFinderModal() {
            document.getElementById('finder-modal').classList.add('active');
        }

        function closeFinderModal() {
            document.getElementById('finder-modal').classList.remove('active');
        }

        function openSheetSelectorModal() {
            // Set the current selection
            const currentRadio = document.querySelector(`input[name="sheet"][value="${currentSheet}"]`);
            if (currentRadio) {
                currentRadio.checked = true;
            }
            document.getElementById('sheet-selector-modal').classList.add('active');
        }

        function closeSheetSelectorModal() {
            document.getElementById('sheet-selector-modal').classList.remove('active');
        }

        function openSettingsModal() {
            updateThemeButtons();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        // =====================================================
        // THEME FUNCTIONS
        // =====================================================
        function setTheme(theme) {
            // Remove all theme classes
            document.body.classList.remove('theme-purple', 'theme-blue', 'theme-green', 'theme-orange', 'theme-dark');
            
            // Add new theme class
            document.body.classList.add(`theme-${theme}`);
            
            // Save to localStorage
            localStorage.setItem('app-theme', theme);
            
            // Update button states
            updateThemeButtons();
        }

        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('app-theme') || 'purple';
            setTheme(savedTheme);
        }

        function updateThemeButtons() {
            const currentTheme = localStorage.getItem('app-theme') || 'purple';
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === currentTheme) {
                    btn.classList.add('active');
                }
            });
        }

        // =====================================================
        // DATE & SHEET HELPERS
        // =====================================================
        function getCurrentSheetName() {
            const now = new Date();
            return `${now.getFullYear()}/${now.getMonth() + 1}`;
        }

        function updateCurrentSheetDisplay() {
            const sheetName = getCurrentSheetName();
            const sheetDisplay = document.getElementById('current-sheet');
            
            if (currentSheet === 'test') {
                sheetDisplay.className = 'current-sheet test-mode';
                sheetDisplay.textContent = `âš ï¸ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${sheetName}`;
            } else {
                sheetDisplay.className = 'current-sheet';
                sheetDisplay.textContent = `ğŸ“… å¯¾è±¡ã‚·ãƒ¼ãƒˆ: ${sheetName}`;
            }
        }

        function getDateString() {
            const now = new Date();
            return `${now.getMonth() + 1}/${now.getDate()}`;
        }

        // =====================================================
        // QR SCANNER (Option A: Stop after each scan)
        // =====================================================
        function toggleScanner() {
            if (scannerActive) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const qrReader = document.getElementById('qr-reader');
            qrReader.style.display = 'block';
            document.getElementById('scan-add-btn').classList.add('active');
            document.getElementById('scan-add-btn').textContent = 'ğŸ”´ ã‚¹ã‚­ãƒ£ãƒ³ä¸­...';

            html5QrCode = new Html5Qrcode('qr-reader');

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    addPart(decodedText, false, null);
                    showStatus('batch-status', `âœ… ${decodedText} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
                    setTimeout(() => hideStatus('batch-status'), 2000);
                    stopScanner();
                },
                (errorMessage) => {}
            ).catch((err) => {
                showStatus('batch-status', 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + err, 'error');
                stopScanner();
            });

            scannerActive = true;
        }

        function stopScanner() {
            if (html5QrCode && scannerActive) {
                html5QrCode.stop().then(() => {
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('scan-add-btn').classList.remove('active');
                    document.getElementById('scan-add-btn').textContent = 'ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³è¿½åŠ ';
                    scannerActive = false;
                }).catch(console.log);
            }
        }

        // =====================================================
        // S/N QR SCANNER
        // =====================================================
        function openSnScanner(index) {
            stopScanner();
            closeSnScanner();

            const readerId = `sn-qr-reader-${index}`;
            const readerElement = document.getElementById(readerId);
            
            if (!readerElement) return;

            readerElement.style.display = 'block';
            snScannerIndex = index;

            snScanner = new Html5Qrcode(readerId);

            snScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 200, height: 200 } },
                (decodedText) => {
                    // Set the scanned value directly to S/N (bypasses chip selection)
                    parts[index].sn = decodedText;
                    parts[index].snUnit = '';
                    parts[index].snNumber = '';
                    closeSnScanner();
                    renderPartsList();
                    showStatus('batch-status', `âœ… S/N: ${decodedText} ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ`, 'success');
                    setTimeout(() => hideStatus('batch-status'), 2000);
                },
                (errorMessage) => {}
            ).catch((err) => {
                showStatus('batch-status', 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + err, 'error');
            });

            snScannerActive = true;
        }

        function closeSnScanner() {
            if (snScanner && snScannerActive) {
                snScanner.stop().then(() => {
                    if (snScannerIndex >= 0) {
                        const readerElement = document.getElementById(`sn-qr-reader-${snScannerIndex}`);
                        if (readerElement) {
                            readerElement.style.display = 'none';
                        }
                    }
                    snScannerActive = false;
                    snScannerIndex = -1;
                }).catch(console.log);
            }
        }

        // =====================================================
        // PARTS LIST MANAGEMENT
        // =====================================================
        function addPart(pn, showLocation = false, locationData = null) {
            if (parts.some(p => p.pn === pn)) {
                showStatus('batch-status', `âš ï¸ ${pn} ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã™`, 'error');
                setTimeout(() => hideStatus('batch-status'), 2000);
                return;
            }

            parts.push({
                pn: pn,
                purpose: '',
                sn: '',
                snUnit: '',
                snNumber: '',
                qty: 1,
                showLocation: showLocation,
                location: locationData ? locationData.location : '',
                tempLocation: locationData ? locationData.tempLocation : ''
            });

            renderPartsList();
            updateSubmitButton();
        }

        function removePart(index) {
            parts.splice(index, 1);
            renderPartsList();
            updateSubmitButton();
        }

        function updatePart(index, field, value) {
            parts[index][field] = value;
            updateSubmitButton();
        }

        function renderPartsList() {
            const container = document.getElementById('parts-list');

            if (parts.length === 0) {
                container.innerHTML = '<div class="parts-list-empty">QRã‚¹ã‚­ãƒ£ãƒ³ã¾ãŸã¯ãƒªã‚¹ãƒˆè²¼ä»˜ã‘ã§éƒ¨å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }

            container.innerHTML = parts.map((part, index) => `
                <div class="part-item">
                    <div class="part-header">
                        <div>
                            <span class="part-index">#${index + 1}</span>
                            <span class="part-number">${part.pn}</span>
                        </div>
                        <button class="delete-btn" onclick="removePart(${index})">ğŸ—‘ï¸</button>
                    </div>
                    ${part.showLocation ? `
                        <div class="inline-location">
                            ğŸ“ ${part.location || 'å ´æ‰€ä¸æ˜'}${part.tempLocation ? ` (ä»®: ${part.tempLocation})` : ''}
                        </div>
                    ` : ''}
                    <div class="part-fields three-col">
                        <div class="field-group">
                            <label>ç›®çš„</label>
                            <select onchange="updatePart(${index}, 'purpose', this.value)">
                                <option value="">é¸æŠ</option>
                                ${PURPOSE_OPTIONS.map(opt => `<option value="${opt}" ${part.purpose === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                        <div class="field-group">
                            <label>S/N</label>
                            <div class="sn-compact-row">
                                <input type="text" value="${part.sn}" placeholder="S/N" 
                                       onchange="updatePart(${index}, 'sn', this.value)"
                                       id="sn-input-${index}" class="sn-text-input">
                                <button class="sn-btn" onclick="openSnScanner(${index})" title="QRã‚¹ã‚­ãƒ£ãƒ³">ğŸ“·</button>
                                <button class="sn-btn unit-btn" onclick="openUnitModal(${index})" title="Unité¸æŠ">ğŸ­</button>
                            </div>
                        </div>
                        <div class="field-group">
                            <label>æ•°é‡</label>
                            <input type="number" value="${part.qty}" min="1" 
                                   onchange="updatePart(${index}, 'qty', this.value)">
                        </div>
                    </div>
                    <div id="sn-qr-reader-${index}" class="sn-qr-reader-container"></div>
                </div>
            `).join('');
        }

        // Open Unit Code Modal
        function openUnitModal(index) {
            currentSnIndex = index;
            const part = parts[index];
            
            // Set current values in modal
            document.getElementById('unit-number-input').value = part.snNumber || '';
            
            // Clear active state from all chips
            document.querySelectorAll('.unit-modal-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            
            // Set active chip if unit is selected
            if (part.snUnit) {
                const activeChip = document.querySelector(`.unit-modal-chip[data-code="${part.snUnit}"]`);
                if (activeChip) {
                    activeChip.classList.add('active');
                }
            }
            
            updateUnitPreview();
            document.getElementById('unit-modal').classList.add('active');
        }

        function closeUnitModal() {
            document.getElementById('unit-modal').classList.remove('active');
            currentSnIndex = -1;
        }

        function selectUnitChip(code) {
            // Update active state
            document.querySelectorAll('.unit-modal-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector(`.unit-modal-chip[data-code="${code}"]`).classList.add('active');
            
            if (currentSnIndex >= 0) {
                parts[currentSnIndex].snUnit = code;
            }
            updateUnitPreview();
        }

        function onUnitNumberChange(value) {
            if (currentSnIndex >= 0) {
                parts[currentSnIndex].snNumber = value;
            }
            updateUnitPreview();
        }

        function updateUnitPreview() {
            const previewBtn = document.getElementById('unit-confirm-btn');
            if (currentSnIndex >= 0) {
                const unit = parts[currentSnIndex].snUnit || '';
                const number = parts[currentSnIndex].snNumber || '';
                
                if (unit && number) {
                    previewBtn.textContent = `ğŸ” æ¤œç´¢: ${unit}-${number}`;
                    previewBtn.disabled = false;
                } else if (unit) {
                    previewBtn.textContent = `ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                    previewBtn.disabled = true;
                } else if (number) {
                    previewBtn.textContent = `Unitã‚’é¸æŠã—ã¦ãã ã•ã„`;
                    previewBtn.disabled = true;
                } else {
                    previewBtn.textContent = `Unitã‚’é¸æŠã—ã¦ãã ã•ã„`;
                    previewBtn.disabled = true;
                }
            }
        }

        async function confirmUnitSelection() {
            if (currentSnIndex >= 0) {
                const unit = parts[currentSnIndex].snUnit || '';
                const number = parts[currentSnIndex].snNumber || '';
                
                if (unit && number) {
                    // Show loading state
                    const previewBtn = document.getElementById('unit-confirm-btn');
                    previewBtn.textContent = 'ğŸ” æ¤œç´¢ä¸­...';
                    previewBtn.disabled = true;
                    
                    try {
                        // Search Ghost Tracker sheet for full S/N
                        const fullSN = await lookupGhostTrackerSN(unit, number);
                        
                        if (fullSN) {
                            parts[currentSnIndex].sn = fullSN;
                            showStatus('batch-status', `âœ… S/N: ${fullSN} ã‚’å–å¾—ã—ã¾ã—ãŸ`, 'success');
                            setTimeout(() => hideStatus('batch-status'), 3000);
                        } else {
                            // Fallback to simple format if not found
                            const unitConfig = UNIT_CODES.find(u => u.code === unit);
                            const snCode = unitConfig ? unitConfig.snCode : unit;
                            parts[currentSnIndex].sn = `${snCode}-${number}`;
                            showStatus('batch-status', `âš ï¸ Ghost Trackerã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚${snCode}-${number} ã‚’è¨­å®šã—ã¾ã—ãŸ`, 'error');
                            setTimeout(() => hideStatus('batch-status'), 3000);
                        }
                    } catch (error) {
                        console.error('Ghost Tracker lookup error:', error);
                        // Fallback to simple format on error
                        const unitConfig = UNIT_CODES.find(u => u.code === unit);
                        const snCode = unitConfig ? unitConfig.snCode : unit;
                        parts[currentSnIndex].sn = `${snCode}-${number}`;
                        showStatus('batch-status', `âš ï¸ æ¤œç´¢ã‚¨ãƒ©ãƒ¼ã€‚${snCode}-${number} ã‚’è¨­å®šã—ã¾ã—ãŸ`, 'error');
                        setTimeout(() => hideStatus('batch-status'), 3000);
                    }
                    
                    renderPartsList();
                }
            }
            closeUnitModal();
        }

        // Lookup S/N from Ghost Tracker sheet
        async function lookupGhostTrackerSN(unitCode, number) {
            const unitConfig = UNIT_CODES.find(u => u.code === unitCode);
            if (!unitConfig || !unitConfig.sheetTab) {
                return null;
            }
            
            try {
                // Fetch data from the specific tab
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GHOST_TRACKER_SHEET_ID}/values/${encodeURIComponent(unitConfig.sheetTab)}!A:Z`;
                const data = await sheetsApiRequest(url);
                
                const rows = data.values || [];
                if (rows.length < 2) return null;
                
                // Find S/N column (usually first column or column named "S/N")
                const headers = rows[0];
                let snColIndex = headers.findIndex(h => /^S\/?N$/i.test((h || '').trim()));
                if (snColIndex === -1) {
                    // Try to find by looking for GT###-XXX-##### pattern in first few rows
                    for (let ci = 0; ci < headers.length && ci < 10; ci++) {
                        for (let ri = 1; ri < Math.min(rows.length, 5); ri++) {
                            const val = rows[ri][ci] || '';
                            if (/^GT\d{3}-[A-Z0-9]{2,3}-\d{3,5}$/i.test(val)) {
                                snColIndex = ci;
                                break;
                            }
                        }
                        if (snColIndex !== -1) break;
                    }
                }
                
                if (snColIndex === -1) snColIndex = 0; // Default to first column
                
                // Search for matching number in S/N column
                const paddedNum = number.toString().padStart(5, '0');
                const snCodeUpper = unitConfig.snCode.toUpperCase();
                
                for (let i = 1; i < rows.length; i++) {
                    const cellValue = (rows[i][snColIndex] || '').trim().toUpperCase();
                    
                    // Match pattern: GT###-XXX-#####
                    const match = cellValue.match(/^(GT\d{3})-([A-Z0-9]{2,3})-(\d{3,5})$/);
                    if (match) {
                        const [, prefix, code, num] = match;
                        const numPadded = num.padStart(5, '0');
                        
                        // Check if code matches and number matches
                        if (code === snCodeUpper && (num === number.toString() || numPadded === paddedNum || parseInt(num) === parseInt(number))) {
                            return cellValue; // Return the full S/N from sheet
                        }
                    }
                }
                
                return null; // Not found
            } catch (error) {
                console.error('Error looking up Ghost Tracker:', error);
                throw error;
            }
        }

        // Track which part's S/N is being edited
        let currentSnIndex = -1;

        function updateSubmitButton() {
            const btn = document.getElementById('submit-btn');
            const validParts = parts.filter(p => p.purpose);
            
            btn.textContent = `ä¸€æ‹¬ç™»éŒ²ã™ã‚‹ (${validParts.length}ä»¶)`;
            btn.disabled = validParts.length === 0;
        }

        // =====================================================
        // PASTE MODAL
        // =====================================================
        function openPasteModal() {
            document.getElementById('paste-modal').classList.add('active');
            document.getElementById('paste-textarea').value = '';
            document.getElementById('paste-textarea').focus();
        }

        function closePasteModal() {
            document.getElementById('paste-modal').classList.remove('active');
        }

        async function processPastedList() {
            const text = document.getElementById('paste-textarea').value;
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (lines.length === 0) {
                return;
            }

            closePasteModal();
            showStatus('batch-status', 'éƒ¨å“æƒ…å ±ã‚’å–å¾—ä¸­...', 'loading');

            try {
                if (!databaseCache) {
                    databaseCache = await loadDatabase();
                }

                let added = 0;
                lines.forEach(pn => {
                    if (!parts.some(p => p.pn === pn)) {
                        const found = databaseCache.find(row => row.partNumber === pn);
                        const locationData = found ? {
                            location: found.location,
                            tempLocation: found.tempLocation
                        } : null;

                        parts.push({
                            pn: pn,
                            purpose: '',
                            sn: '',
                            snUnit: '',
                            snNumber: '',
                            qty: 1,
                            showLocation: true,
                            location: locationData ? locationData.location : '',
                            tempLocation: locationData ? locationData.tempLocation : ''
                        });
                        added++;
                    }
                });

                renderPartsList();
                updateSubmitButton();

                document.getElementById('finder-input').value = lines.join('\n');
                await autoSearchFinder(lines);

                if (added > 0) {
                    showStatus('batch-status', `âœ… ${added}ä»¶ã®éƒ¨å“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆå ´æ‰€æƒ…å ±ä»˜ãï¼‰`, 'success');
                    setTimeout(() => hideStatus('batch-status'), 3000);
                }

            } catch (error) {
                console.error('Error:', error);
                showStatus('batch-status', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // =====================================================
        // BATCH SUBMIT
        // =====================================================
        async function submitBatch() {
            const validParts = parts.filter(p => p.purpose);
            
            if (validParts.length === 0) {
                showStatus('batch-status', 'ç›®çš„ãŒé¸æŠã•ã‚Œã¦ã„ãªã„éƒ¨å“ãŒã‚ã‚Šã¾ã™', 'error');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»éŒ²ä¸­...';
            showStatus('batch-status', 'ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...', 'loading');

            try {
                const sheetName = getCurrentSheetName();
                const spreadsheetId = getCurrentSpreadsheetId();

                const sheetExists = await checkSheetExists(sheetName, spreadsheetId);
                if (!sheetExists) {
                    await createNewSheet(sheetName, spreadsheetId);
                }

                let nextRow = await getNextRowNumber(sheetName, spreadsheetId);
                const dateStr = getDateString();
                const remarks = document.getElementById('remarks').value.trim();

                // Write each row individually to ensure proper column alignment
                for (let i = 0; i < validParts.length; i++) {
                    const part = validParts[i];
                    // Plain values - same as v7 app
                    const rowData = [
                        dateStr,                        // B: æ—¥ä»˜
                        userProfile.name,               // C: åå‰
                        part.pn || '',                  // D: éƒ¨å“ç•ªå·
                        '',                             // E: éƒ¨å“ç•ªå·(è‡ªå‹•å…¥åŠ›)
                        '',                             // F: éƒ¨å“å(è‡ªå‹•å…¥åŠ›)
                        String(part.qty || 1),          // G: æ•°é‡
                        part.purpose || '',             // H: ç›®çš„
                        part.sn || '',                  // I: SN
                        remarks || ''                   // J: å‚™è€ƒæ¬„
                    ];
                    
                    await writeRow(sheetName, nextRow + i, rowData, spreadsheetId);
                }

                showStatus('batch-status', `âœ… ${validParts.length}ä»¶ã®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼`, 'success');

                parts = [];
                renderPartsList();
                updateSubmitButton();
                document.getElementById('remarks').value = '';

            } catch (error) {
                console.error('Error:', error);
                showStatus('batch-status', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                updateSubmitButton();
            }
        }

        // =====================================================
        // PART FINDER
        // =====================================================
        async function findParts() {
            const input = document.getElementById('finder-input').value;
            const partNumbers = input.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (partNumbers.length === 0) {
                showStatus('finder-status', 'éƒ¨å“ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showStatus('finder-status', 'æ¤œç´¢ä¸­...', 'loading');

            try {
                if (!databaseCache) {
                    databaseCache = await loadDatabase();
                }

                const results = partNumbers.map(pn => {
                    const found = databaseCache.find(row => row.partNumber === pn);
                    return { pn, found: !!found, data: found };
                });

                renderFinderResults(results);
                hideStatus('finder-status');

            } catch (error) {
                console.error('Error:', error);
                showStatus('finder-status', 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        async function autoSearchFinder(partNumbers) {
            try {
                if (!databaseCache) {
                    databaseCache = await loadDatabase();
                }

                const results = partNumbers.map(pn => {
                    const found = databaseCache.find(row => row.partNumber === pn);
                    return { pn, found: !!found, data: found };
                });

                renderFinderResults(results);
            } catch (error) {
                console.error('Error in auto search:', error);
            }
        }

        async function loadDatabase() {
            const spreadsheetId = SHEETS_CONFIG.SPREADSHEETS.production.id;
            const databaseSheet = SHEETS_CONFIG.SPREADSHEETS.production.database;
            
            const data = await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(databaseSheet)}!A:Z`
            );

            const rows = data.values || [];
            
            if (rows.length < 2) return [];

            const headers = rows[0];
            const colIndex = {
                partNumber: headers.indexOf('éƒ¨å“ç•ªå·'),
                name: headers.indexOf('ç‰©å“å'),
                location: headers.indexOf('ä¿ç®¡å ´æ‰€'),
                tempLocation: headers.indexOf('ä»®ä¿ç®¡å ´æ‰€'),
                quantity: headers.indexOf('æ•°é‡'),
                category: headers.indexOf('ã‚«ãƒ†ã‚´ãƒª')
            };

            return rows.slice(1).map(row => ({
                partNumber: row[colIndex.partNumber] || '',
                name: row[colIndex.name] || '',
                location: row[colIndex.location] || '',
                tempLocation: row[colIndex.tempLocation] || '',
                quantity: row[colIndex.quantity] || '',
                category: row[colIndex.category] || ''
            })).filter(row => row.partNumber);
        }

        function renderFinderResults(results) {
            const container = document.getElementById('finder-results');

            container.innerHTML = results.map(result => {
                if (result.found) {
                    const d = result.data;
                    return `
                        <div class="finder-result-item found">
                            <div class="finder-pn">âœ… ${result.pn}</div>
                            <div class="finder-details">
                                <div class="finder-detail">
                                    <span class="finder-detail-label">ç‰©å“å</span>
                                    <span class="finder-detail-value">${d.name}</span>
                                </div>
                                <div class="finder-detail">
                                    <span class="finder-detail-label">æ•°é‡</span>
                                    <span class="finder-detail-value">${d.quantity}</span>
                                </div>
                            </div>
                            <div class="location-highlight">
                                <span class="icon">ğŸ“</span>
                                <span class="text">${d.location}</span>
                                ${d.tempLocation ? `<span style="color:#666; margin-left:10px;">(ä»®: ${d.tempLocation})</span>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="finder-result-item not-found">
                            <div class="finder-pn">âŒ ${result.pn}</div>
                            <div style="color: #c62828; font-size: 0.9rem;">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // =====================================================
        // GOOGLE SHEETS API HELPERS
        // =====================================================
        async function checkSheetExists(sheetName, spreadsheetId) {
            const data = await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties.title`
            );
            return (data.sheets || []).some(sheet => sheet.properties.title === sheetName);
        }

        async function createNewSheet(sheetName, spreadsheetId) {
            await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,
                {
                    method: 'POST',
                    body: JSON.stringify({
                        requests: [{ addSheet: { properties: { title: sheetName } } }]
                    })
                }
            );

            const headers = [
                'No.', 'æ—¥ä»˜', 'åå‰', 'éƒ¨å“ç•ªå·ã‹QRã®å€¤ã‚’å…¥åŠ›', 'éƒ¨å“ç•ªå·(è‡ªå‹•å…¥åŠ›)',
                'éƒ¨å“å(è‡ªå‹•å…¥åŠ›)', 'æ•°é‡', 'ç›®çš„', 'SN', 'å‚™è€ƒæ¬„', 'å‡ºåº«è€…',
                'å‡¦ç†çŠ¶æ³', 'è²¸å‡ºçŠ¶æ³', 'ä¿ç®¡å ´æ‰€', 'ä»®ä¿ç®¡å ´æ‰€', 'éƒ¨ç½²', 'å‡ºåº«ãƒ¡ãƒ¢'
            ];

            await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(sheetName)}!A1:Q1?valueInputOption=RAW`,
                {
                    method: 'PUT',
                    body: JSON.stringify({ values: [headers] })
                }
            );
        }

        async function getNextRowNumber(sheetName, spreadsheetId) {
            const data = await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(sheetName)}!B:B`
            );
            return (data.values || []).length + 1;
        }

        async function writeMultipleRows(sheetName, startRow, rows, spreadsheetId) {
            const endRow = startRow + rows.length - 1;
            const range = `${sheetName}!B${startRow}:J${endRow}`;

            await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
                {
                    method: 'PUT',
                    body: JSON.stringify({ values: rows })
                }
            );
        }

        // Write a single row to ensure proper column alignment
        async function writeRow(sheetName, rowNumber, rowData, spreadsheetId) {
            const range = `${sheetName}!B${rowNumber}:J${rowNumber}`;

            await sheetsApiRequest(
                `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
                {
                    method: 'PUT',
                    body: JSON.stringify({ values: [rowData] })
                }
            );
        }

        // =====================================================
        // STATUS HELPERS
        // =====================================================
        function showStatus(elementId, message, type) {
            const status = document.getElementById(elementId);
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function hideStatus(elementId) {
            const status = document.getElementById(elementId);
            status.className = 'status';
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºåº«ä¾é ¼å…¥åŠ›</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }

        .current-sheet {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 500;
        }

        /* Login Section */
        #login-section {
            text-align: center;
            padding: 40px 20px;
        }

        #login-section p {
            color: #666;
            margin-bottom: 20px;
        }

        .login-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .login-btn:hover {
            background: #3367d6;
        }

        /* Form Section */
        #form-section {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* QR Scanner Section */
        .qr-section {
            margin-bottom: 20px;
        }

        .qr-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .qr-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .qr-btn:hover {
            background: #667eea;
            color: white;
        }

        .qr-btn.active {
            background: #667eea;
            color: white;
        }

        #qr-reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        #qr-reader video {
            border-radius: 10px;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Status Messages */
        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            display: block;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }

        .status.loading {
            background: #e3f2fd;
            color: #1565c0;
            display: block;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .user-info span {
            color: #666;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: none;
            border: 1px solid #999;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: #eee;
        }

        /* Recent Entry */
        .recent-entry {
            margin-top: 20px;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
        }

        .recent-entry h3 {
            color: #333;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .recent-entry p {
            color: #666;
            font-size: 0.85rem;
            margin: 4px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ“¦ å‡ºåº«ä¾é ¼å…¥åŠ›</h1>
            <p class="subtitle">ç”Ÿç”£ãƒãƒ¼ãƒ å‡ºåº«ä¾é ¼ã‚·ãƒ¼ãƒˆ</p>

            <!-- Login Section -->
            <div id="login-section">
                <p>Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
                <button class="login-btn" onclick="handleLogin()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>

            <!-- Form Section -->
            <div id="form-section">
                <div class="user-info">
                    <span id="user-email"></span>
                    <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>

                <div class="current-sheet" id="current-sheet">
                    ğŸ“… å¯¾è±¡ã‚·ãƒ¼ãƒˆ: èª­ã¿è¾¼ã¿ä¸­...
                </div>

                <!-- QR Scanner -->
                <div class="qr-section">
                    <label>éƒ¨å“ç•ªå·ã‹QRã®å€¤ã‚’å…¥åŠ›</label>
                    <div class="qr-buttons">
                        <button class="qr-btn" id="scan-btn" onclick="toggleScanner()">
                            ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³
                        </button>
                        <button class="qr-btn" id="manual-btn" onclick="focusManualInput()">
                            âŒ¨ï¸ æ‰‹å…¥åŠ›
                        </button>
                    </div>
                    <div id="qr-reader"></div>
                    <input type="text" id="part-number" placeholder="éƒ¨å“ç•ªå·ã¾ãŸã¯QRå€¤">
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label>æ•°é‡</label>
                    <input type="number" id="quantity" value="1" min="1">
                </div>

                <!-- Purpose -->
                <div class="form-group">
                    <label>ç›®çš„</label>
                    <select id="purpose">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é€šå¸¸çµ„ç«‹">é€šå¸¸çµ„ç«‹</option>
                        <option value="ä¸è‰¯éƒ¨å“">ä¸è‰¯éƒ¨å“</option>
                        <option value="ä»•æç™ºç”Ÿ">ä»•æç™ºç”Ÿ</option>
                        <option value="PICK UPä¸è¶³">PICK UPä¸è¶³</option>
                        <option value="å¸‚å ´å“ä¿®ç†">å¸‚å ´å“ä¿®ç†</option>
                        <option value="ECNå¯¾å¿œ">ECNå¯¾å¿œ</option>
                        <option value="BYæ§‹ç¯‰">BYæ§‹ç¯‰</option>
                        <option value="ç”Ÿç”£ã‚¸ã‚°">ç”Ÿç”£ã‚¸ã‚°</option>
                        <option value="ç¢ºèªä¸­">ç¢ºèªä¸­</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                        <option value="å‡ºåº«ã‚­ãƒ£ãƒ³ã‚»ãƒ«">å‡ºåº«ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                    </select>
                </div>

                <!-- Serial Number -->
                <div class="form-group">
                    <label>SN (ã‚·ãƒªã‚¢ãƒ«ç•ªå·)</label>
                    <input type="text" id="serial-number" placeholder="ä¾‹: GT504-ARM-00086">
                </div>

                <!-- Remarks -->
                <div class="form-group">
                    <label>å‚™è€ƒæ¬„</label>
                    <textarea id="remarks" placeholder="å‚™è€ƒãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
                </div>

                <!-- Submit Button -->
                <button class="submit-btn" id="submit-btn" onclick="submitEntry()">
                    ç™»éŒ²ã™ã‚‹
                </button>

                <!-- Status Message -->
                <div class="status" id="status"></div>

                <!-- Recent Entry -->
                <div class="recent-entry" id="recent-entry">
                    <h3>âœ… ç›´å‰ã®ç™»éŒ²</h3>
                    <p id="recent-part"></p>
                    <p id="recent-qty"></p>
                    <p id="recent-purpose"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // CONFIGURATION - UPDATE THESE VALUES
        // =====================================================
        const CONFIG = {
            CLIENT_ID: '1088099187141-ut0dn0scqt3h99htf3rg8gsrg2oo1ad8.apps.googleusercontent.com',
            SPREADSHEET_ID: '1hTbs5vFzaEAQ87y078-_O5xoP_ad3joRGkneC-8yNzk',
            SCOPES: 'https://www.googleapis.com/auth/spreadsheets',
            USER_NAME: 'Aniket'
        };
        // =====================================================

        let accessToken = null;
        let tokenClient = null;
        let html5QrCode = null;
        let scannerActive = false;

        // Initialize on page load
        window.onload = function() {
            initializeGoogleAuth();
            updateCurrentSheetDisplay();
        };

        // Google Auth Initialization
        function initializeGoogleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        localStorage.setItem('gsheet_access_token', accessToken);
                        showForm();
                    }
                },
            });

            // Check if we have a stored token
            const storedToken = localStorage.getItem('gsheet_access_token');
            if (storedToken) {
                accessToken = storedToken;
                validateToken();
            }
        }

        // Validate stored token
        async function validateToken() {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + accessToken);
                if (response.ok) {
                    showForm();
                } else {
                    localStorage.removeItem('gsheet_access_token');
                    accessToken = null;
                }
            } catch (error) {
                localStorage.removeItem('gsheet_access_token');
                accessToken = null;
            }
        }

        // Handle Login
        function handleLogin() {
            tokenClient.requestAccessToken();
        }

        // Handle Logout
        function handleLogout() {
            const tokenToRevoke = accessToken;
            accessToken = null;
            localStorage.removeItem('gsheet_access_token');
            if (tokenToRevoke) {
                google.accounts.oauth2.revoke(tokenToRevoke);
            }
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('form-section').style.display = 'none';
            stopScanner();
        }

        // Show Form after login
        function showForm() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('user-email').textContent = 'ğŸ‘¤ ' + CONFIG.USER_NAME;
        }

        // Get current month sheet name (format: YYYY/M)
        function getCurrentSheetName() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1; // 1-12
            return `${year}/${month}`;
        }

        // Update the current sheet display
        function updateCurrentSheetDisplay() {
            const sheetName = getCurrentSheetName();
            document.getElementById('current-sheet').textContent = `ğŸ“… å¯¾è±¡ã‚·ãƒ¼ãƒˆ: ${sheetName}`;
        }

        // QR Scanner Functions
        function toggleScanner() {
            if (scannerActive) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            const qrReader = document.getElementById('qr-reader');
            qrReader.style.display = 'block';
            document.getElementById('scan-btn').classList.add('active');
            
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    document.getElementById('part-number').value = decodedText;
                    stopScanner();
                    showStatus('QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ', 'success');
                    setTimeout(() => hideStatus(), 2000);
                },
                (errorMessage) => {
                    // Ignore scan errors
                }
            ).catch((err) => {
                showStatus('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“: ' + err, 'error');
            });
            
            scannerActive = true;
        }

        function stopScanner() {
            if (html5QrCode && scannerActive) {
                html5QrCode.stop().then(() => {
                    document.getElementById('qr-reader').style.display = 'none';
                    document.getElementById('scan-btn').classList.remove('active');
                    scannerActive = false;
                }).catch((err) => {
                    console.log('Error stopping scanner:', err);
                });
            }
        }

        function focusManualInput() {
            stopScanner();
            document.getElementById('part-number').focus();
        }

        // Submit Entry to Google Sheets
        async function submitEntry() {
            const partNumber = document.getElementById('part-number').value.trim();
            const quantity = document.getElementById('quantity').value;
            const purpose = document.getElementById('purpose').value;
            const serialNumber = document.getElementById('serial-number').value.trim();
            const remarks = document.getElementById('remarks').value.trim();

            // Validation
            if (!partNumber) {
                showStatus('éƒ¨å“ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!quantity || quantity < 1) {
                showStatus('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            if (!purpose) {
                showStatus('ç›®çš„ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // Disable submit button
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»éŒ²ä¸­...';
            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...', 'loading');

            try {
                const sheetName = getCurrentSheetName();
                
                // First, check if sheet exists
                const sheetExists = await checkSheetExists(sheetName);
                
                if (!sheetExists) {
                    // Create new sheet
                    await createNewSheet(sheetName);
                }

                // Get the next empty row number
                const nextRow = await getNextRowNumber(sheetName);

                // Format date as M/D
                const now = new Date();
                const dateStr = `${now.getMonth() + 1}/${now.getDate()}`;

                // Data for columns B through J (skipping A which has formula)
                const rowData = [
                    dateStr,               // B: æ—¥ä»˜
                    CONFIG.USER_NAME,      // C: åå‰
                    partNumber,            // D: éƒ¨å“ç•ªå·ã‹QRã®å€¤ã‚’å…¥åŠ›
                    '',                    // E: éƒ¨å“ç•ªå·(è‡ªå‹•å…¥åŠ›) - formula will fill
                    '',                    // F: éƒ¨å“å(è‡ªå‹•å…¥åŠ›) - formula will fill
                    quantity,              // G: æ•°é‡
                    purpose,               // H: ç›®çš„
                    serialNumber,          // I: SN
                    remarks                // J: å‚™è€ƒæ¬„
                ];

                // Write to specific row, columns B through J
                await writeToRow(sheetName, nextRow, rowData);

                // Success
                showStatus('âœ… ç™»éŒ²å®Œäº†!', 'success');
                
                // Show recent entry
                document.getElementById('recent-entry').style.display = 'block';
                document.getElementById('recent-part').textContent = `éƒ¨å“: ${partNumber}`;
                document.getElementById('recent-qty').textContent = `æ•°é‡: ${quantity}`;
                document.getElementById('recent-purpose').textContent = `ç›®çš„: ${purpose}`;

                // Clear form
                document.getElementById('part-number').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('purpose').value = '';
                document.getElementById('serial-number').value = '';
                document.getElementById('remarks').value = '';

            } catch (error) {
                console.error('Error:', error);
                showStatus('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™»éŒ²ã™ã‚‹';
            }
        }

        // Check if sheet exists
        async function checkSheetExists(sheetName) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}?fields=sheets.properties.title`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Sheet check error:', errorData);
                throw new Error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“');
            }

            const data = await response.json();
            const sheets = data.sheets || [];
            return sheets.some(sheet => sheet.properties.title === sheetName);
        }

        // Create new sheet
        async function createNewSheet(sheetName) {
            // First, add the new sheet
            const addSheetResponse = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}:batchUpdate`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        requests: [{
                            addSheet: {
                                properties: {
                                    title: sheetName
                                }
                            }
                        }]
                    })
                }
            );

            if (!addSheetResponse.ok) {
                throw new Error('æ–°ã—ã„ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã§ãã¾ã›ã‚“');
            }

            // Add headers to the new sheet
            const headers = [
                'No.', 'æ—¥ä»˜', 'åå‰', 'éƒ¨å“ç•ªå·ã‹QRã®å€¤ã‚’å…¥åŠ›', 'éƒ¨å“ç•ªå·(è‡ªå‹•å…¥åŠ›)', 
                'éƒ¨å“å(è‡ªå‹•å…¥åŠ›)', 'æ•°é‡', 'ç›®çš„', 'SN', 'å‚™è€ƒæ¬„', 'å‡ºåº«è€…', 
                'å‡¦ç†çŠ¶æ³', 'è²¸å‡ºçŠ¶æ³', 'ä¿ç®¡å ´æ‰€', 'ä»®ä¿ç®¡å ´æ‰€', 'éƒ¨ç½²', 'å‡ºåº«ãƒ¡ãƒ¢'
            ];

            await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!A1:Q1?valueInputOption=RAW`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [headers]
                    })
                }
            );
        }

        // Get the next empty row number by checking Column B (æ—¥ä»˜)
        async function getNextRowNumber(sheetName) {
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!B:B`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error('è¡Œæ•°ã‚’å–å¾—ã§ãã¾ã›ã‚“');
            }

            const data = await response.json();
            const values = data.values || [];
            return values.length + 1; // Next empty row
        }

        // Write data to a specific row, columns B through J
        async function writeToRow(sheetName, rowNumber, rowData) {
            const range = `${sheetName}!B${rowNumber}:J${rowNumber}`;
            
            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SPREADSHEET_ID}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        values: [rowData]
                    })
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã§ãã¾ã›ã‚“');
            }

            return await response.json();
        }

        // Status message functions
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.className = 'status';
        }
    </script>
</body>
</html>
